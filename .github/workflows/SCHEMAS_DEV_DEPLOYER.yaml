name: SCHEMAS_DEV_DEPLOYER

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to run against"
        required: true
        default: "master"
      bq_project:
        type: choice
        description: "BigQuery project to run against"
        required: true
        options:
          - mentor-development
        default: "mentor-development"
      bq_dataset:
        description: "BigQuery dataset / folder in this repo where DDL queries should be executed from"
      whitelist_regex:
        description: "Whitelist regular expression"
        required: true
      blacklist_regex:
        description: "Blacklist regular expression"
        required: false
        default: "$^"   # matching nothing by default

env:
  GCP_PROJECT_ID: "mentor-development"
  SERVICE_ACCOUNT_DEPLOYER: ${{ secrets.GOOGLE_KEY_DEV }}

jobs:
  deploy-schemas:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ inputs.branch }}
    
      - name: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          credentials_json: ${{ env.SERVICE_ACCOUNT_DEPLOYER }}

      # Install gcloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2     
        with:
            project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Deploy Tables and Views
        id: deploy-tables-and-views
        run: |
          WHITELIST_REGEX="${{ inputs.whitelist_regex }}"   # Regex of files to include
          BLACKLIST_REGEX="${{ inputs.blacklist_regex }}"   # Regex of files to exclude (matches nothing by default)
          BQ_PROJECT="${{ inputs.bq_project }}"             # BigQuery project to run against
          BQ_DATASET="${{ inputs.bq_dataset }}"             # BigQuery dataset / folder in this repo
          SQL_DIR=$BQ_DATASET

          # -----------------------------
          # Validation
          # -----------------------------
          if [[ ! -d "$SQL_DIR" ]]; then
            echo "Error: Directory '$SQL_DIR' does not exist."
            exit 1
          fi

          if ! command -v bq >/dev/null 2>&1; then
            echo "Error: 'bq' command not found. Install and authenticate BigQuery CLI."
            exit 1
          fi

          # -----------------------------
          # Execution
          # -----------------------------
          echo "Scanning directory: $SQL_DIR"
          echo "Whitelist regex: $WHITELIST_REGEX"
          echo "Blacklist regex: $BLACKLIST_REGEX"
          echo

          shopt -s nullglob

          for sql_file in "$SQL_DIR"/*.sql; do
            file_name="$(basename "$sql_file")"

            # Apply whitelist
            if ! [[ "$file_name" =~ $WHITELIST_REGEX ]]; then
              continue
            fi

            # Apply blacklist
            if [[ "$file_name" =~ $BLACKLIST_REGEX ]]; then
              continue
            fi

            sql_query=$(sed "s/{{ *clientId *}}/$BQ_DATASET/g" $sql_file) # | \

            echo "Executing SQL query from file $file_name:"
            echo "$sql_query"

            echo "$sql_query" | bq query \
              --use_legacy_sql=false \
              --project_id="$BQ_PROJECT"

            echo "Finished: $file_name"
            echo
          done

          echo "All matching SQL files processed."


